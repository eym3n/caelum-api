from dotenv import load_dotenv
from pydantic import BaseModel, Field
from typing import Annotated, Dict, Any
from langgraph.graph.message import add_messages

load_dotenv()


def replace(a, b):
    return b


class BuilderState(BaseModel):
    """Shared state between Designer, Coder, Clarifier, and other agents in the landing page builder graph."""

    # ğŸ“‚ Session management
    session_id: Annotated[str, replace] = Field(
        default="default",
        description="The ID of the session.",
    )
    job_id: Annotated[str | None, replace] = Field(
        default=None,
        description="Optional job id for this graph execution (used for async logging).",
    )

    # ğŸ—£ï¸ Core conversational stream
    messages: Annotated[list, add_messages]

    # ğŸ§­ Intent management
    user_intent: Annotated[str, replace]
    found_error: Annotated[bool, replace]
    is_followup: Annotated[bool, replace] = Field(
        default=False,
        description="Indicates whether the latest user message is a follow-up request.",
    )

    # ğŸ§° Diff / change tracking (used by Coder Agent)
    lines_added: Annotated[int, replace]
    lines_removed: Annotated[int, replace]

    # ğŸ¨ Design System (Designer Agent)
    raw_designer_output: Annotated[str, replace] = Field(
        default="",
        description="Raw unstructured output from Designer Agent.",
    )
    design_system_run: Annotated[bool, replace] = Field(
        default=False,
        description="Indicates whether the design system pass has completed for the session.",
    )

    # ğŸ’» Coder Agent
    coder_output: Annotated[str, replace] = Field(
        default="", description="Summary or code changes generated by the Coder Agent."
    )
    coder_run: Annotated[bool, replace] = Field(
        default=False,
        description="Indicates whether the coder pass has completed for the session.",
    )

    # ğŸ’¬ Clarifier Agent
    clarify_response: Annotated[str, replace] = Field(
        default="",
        description="Response from Clarifier Agent when no code/design action is needed.",
    )

    # ğŸš¢ Deployment tracking
    deployment_failed: Annotated[bool, replace] = Field(
        default=False,
        description="Indicates whether the deployment failed and needs fixing.",
    )
    deployment_error: Annotated[str, replace] = Field(
        default="",
        description="Error message from failed deployment attempt.",
    )
    deployment_fixer_run: Annotated[bool, replace] = Field(
        default=False,
        description="Indicates whether the deployment fixer has made changes.",
    )

    # ğŸš€ Initialization Payload
    init_payload: Annotated[Dict[str, Any], replace] = Field(
        default_factory=dict,
        description="Raw structured initialization payload captured from /init endpoint.",
    )
    init_payload_text: Annotated[str, replace] = Field(
        default="",
        description="Flattened textual summary of the initialization payload injected as the first human message.",
    )
